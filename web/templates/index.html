<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Parking System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">Smart Parking System</h1>
            <ul class="nav-links">
                <li><a href="/" class="active">Live Dashboard</a></li>
                <li><a href="/booking">Book Now</a></li>
                <li><a href="/my-bookings">My Bookings</a></li>
            </ul>
        </div>
    </nav>

    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <h2>Real-Time Parking Availability</h2>
                <p>Distributed IoT Monitoring & Dynamic Pricing System</p>
                <div class="cta-buttons">
                    <a href="/booking" class="btn btn-secondary">Reserve a Spot</a>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <section class="dashboard-section" style="margin-top: 2rem;">
            <h3>Live Campus Parking Status</h3>
            <div style="overflow-x: auto;">
                <table id="main-table" class="data-table">
                    <thead>
                        <tr>
                            <th>Parking Lot</th>
                            <th>Location</th>
                            <th>Availability</th>
                            <th>Occupancy</th>
                            <th>Status</th>
                            <th>Current Price</th>
                            <th>Rate Type</th>
                        </tr>
                    </thead>
                    <tbody id="main-tbody">
                        <tr>
                            <td colspan="7" style="text-align: center;">Connecting to Distributed Cloud...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        let autoRefresh = null;
        let previousState = {}; 
        
        // Store data globally so we can merge them
        let latestLots = [];
        let latestPricing = {};

        function updateDashboard() {
            // Fetch both endpoints in parallel
            Promise.all([
                fetch('/api/parking-lots').then(res => res.json()),
                fetch('/api/pricing').then(res => res.json())
            ]).then(([lotsData, pricingData]) => {
                
                if (lotsData.success) {
                    latestLots = lotsData.data;
                    localStorage.setItem('cached_parking_lots', JSON.stringify(latestLots));
                }
                
                if (pricingData.success) {
                    // Convert pricing array to a map for easier lookup: { lot_id: price_obj }
                    latestPricing = {};
                    pricingData.data.forEach(p => {
                        latestPricing[p.parking_lot_id] = p;
                    });
                    localStorage.setItem('cached_pricing', JSON.stringify(pricingData.data));
                }

                // Render the unified table
                renderUnifiedTable();

            }).catch(error => console.error('Error syncing dashboard:', error));
        }

        function renderUnifiedTable() {
            const tbody = document.getElementById('main-tbody');
            
            // Clear "Connecting..." message if present
            if (tbody.innerHTML.includes('Connecting')) {
                tbody.innerHTML = '';
            }

            latestLots.forEach(lot => {
                // 1. Get Matching Pricing Data
                const priceInfo = latestPricing[lot.id] || { current_price: 0, is_peak_hour: false };

                // 2. Flash Logic (Visual Detection of Changes)
                let flashClass = '';
                const prev = previousState[lot.id];
                if (prev !== undefined) {
                    if (lot.available_slots > prev) flashClass = 'flash-green'; 
                    else if (lot.available_slots < prev) flashClass = 'flash-red'; 
                }
                previousState[lot.id] = lot.available_slots;

                // 3. Status Badges Logic
                const occupancyClass = lot.occupancy_rate > 80 ? 'high' : lot.occupancy_rate > 50 ? 'medium' : 'low';
                
                let statusText = 'Open';
                let statusClass = 'status-available';
                if (lot.available_slots === 0) {
                    statusText = 'Full';
                    statusClass = 'status-full';
                } else if (lot.available_slots < 3) {
                    statusText = 'Limited';
                    statusClass = 'status-limited';
                }

                const rateText = priceInfo.is_peak_hour ? 'Peak Hour' : 'Standard';
                const rateClass = priceInfo.is_peak_hour ? 'status-peak' : 'status-offpeak';

                // 4. Build Row HTML
                const rowHtml = `
                    <td><strong>${lot.name}</strong></td>
                    <td>${lot.location}</td>
                    <td class="${flashClass}"><strong>${lot.available_slots}</strong> / ${lot.total_slots}</td>
                    <td><span class="occupancy-badge occupancy-${occupancyClass}">${lot.occupancy_rate}%</span></td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td><strong>$${priceInfo.current_price.toFixed(2)}</strong>/hr</td>
                    <td><span class="status-badge ${rateClass}">${rateText}</span></td>
                `;

                // 5. Update DOM efficiently
                let existingRow = document.getElementById(`lot-row-${lot.id}`);
                if (existingRow) {
                    existingRow.innerHTML = rowHtml;
                } else {
                    const row = document.createElement('tr');
                    row.id = `lot-row-${lot.id}`;
                    row.innerHTML = rowHtml;
                    tbody.appendChild(row);
                }
            });
        }

        function loadFromCache() {
            const cachedLots = localStorage.getItem('cached_parking_lots');
            const cachedPricing = localStorage.getItem('cached_pricing');

            if (cachedLots) latestLots = JSON.parse(cachedLots);
            if (cachedPricing) {
                const pData = JSON.parse(cachedPricing);
                latestPricing = {};
                pData.forEach(p => latestPricing[p.parking_lot_id] = p);
            }

            if (latestLots.length > 0) renderUnifiedTable();
        }

        // Start Up
        loadFromCache();
        updateDashboard();
        autoRefresh = setInterval(updateDashboard, 2000); // Check for incoming gateway data every 2s 
    </script>
</body>
</html>